<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>RAYNALDO SHAFRINA WEBSITE</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
.thumbnail-img { width: 150px; height: 150px; object-fit: cover; border-radius: 0.5rem; }
#lightboxImg { max-width: 90vw; max-height: 80vh; }
#photoListWrapper { display: flex; justify-content: center; align-items: center; height: 100%; padding: 1.5rem; }
#photoList { display: grid; grid-template-columns: repeat(2, 150px); grid-auto-rows: 150px; gap: 3rem; }
</style>
</head>
<body class="bg-cover bg-center min-h-screen text-white" 
style="background-image: url('https://images.unsplash.com/photo-1501785888041-af3ef285b470?ixlib=rb-4.0.3&auto=format&fit=crop&w=1600&q=80');">

<!-- Login Page -->
<div id="loginPage" class="flex items-center justify-center min-h-screen">
  <div class="bg-black bg-opacity-70 p-8 rounded-xl shadow-lg w-96">
    <h2 class="text-2xl font-bold mb-4 text-center">Login</h2>
    <input id="username" type="text" placeholder="Username" class="w-full mb-3 px-3 py-2 rounded text-black">
    <input id="password" type="password" placeholder="Password" class="w-full mb-3 px-3 py-2 rounded text-black">
    <button onclick="login()" class="w-full bg-blue-500 hover:bg-blue-600 py-2 rounded">Login</button>
    <p id="loginError" class="text-red-400 mt-2 text-center hidden">Login gagal!</p>
  </div>
</div>

<!-- Anniversary Page -->
<div id="annivPage" class="hidden flex flex-col items-center justify-center min-h-screen bg-black bg-opacity-70 text-white">
  <h2 class="text-2xl font-bold mb-4">Masukkan Tanggal Anniversary</h2>
  <input id="annivInput" type="date" class="px-4 py-2 rounded text-black mb-3">
  <button onclick="checkAnniv()" class="bg-green-500 hover:bg-green-600 px-6 py-2 rounded">Submit</button>
  <p id="annivError" class="text-red-400 mt-2 hidden">Tanggal salah! Coba lagi.</p>
</div>

<!-- Menu Page -->
<div id="menuPage" class="hidden min-h-screen flex flex-col items-center justify-center bg-black bg-opacity-70">
  <h2 class="text-3xl font-bold mb-6">Menu Utama</h2>
  <div class="grid grid-cols-2 gap-6">
    <button onclick="openPage('ucapanPage')" class="bg-blue-500 hover:bg-blue-600 px-6 py-3 rounded-lg shadow-lg">Ucapan</button>
    <button onclick="openPage('kenanganPage')" class="bg-purple-500 hover:bg-purple-600 px-6 py-3 rounded-lg shadow-lg">Kenangan</button>
    <button onclick="openPage('visiPage')" class="bg-green-500 hover:bg-green-600 px-6 py-3 rounded-lg shadow-lg">Visi</button>
    <button onclick="openPage('harapanPage')" class="bg-pink-500 hover:bg-pink-600 px-6 py-3 rounded-lg shadow-lg">Harapan</button>
  </div>
</div>

<!-- Ucapan Page -->
<div id="ucapanPage" class="hidden min-h-screen flex flex-col items-center justify-center bg-black bg-opacity-70 text-center">
  <h2 class="text-2xl font-bold mb-6">ðŸŽ‰Selamat Ulang TahunðŸŽ‰</h2>
  <p class="text-lg max-w-md">Selamat ulang tahun, sayangku. Semoga kamu selalu merasa dicintai, dihargai, dan dimengerti. Ikhlaskan seluruh kekecewaan dan kesedihan mu di masa lalu, karena aku akan selalu bersama mu. Semoga kamu dilapangkan rezekinya, dijaga dari segala marabahaya, dan selalu dikelilingi teman teman yang peduli padamu.</p>
  <button onclick="backToMenu()" class="mt-6 bg-gray-500 hover:bg-gray-600 px-6 py-2 rounded">Kembali</button>
</div>

<!-- Kenangan Page -->
<div id="kenanganPage" class="hidden min-h-screen flex flex-col bg-black bg-opacity-70">
  <div class="flex justify-between items-center p-4">
    <h2 class="text-2xl font-bold">Kenangan</h2>
    <button onclick="addSubmenu()" class="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded">+ Tambah Grup</button>
  </div>
  <div id="submenuList" class="grid grid-cols-2 sm:grid-cols-3 gap-4 p-4"></div>
  <button onclick="backToMenu()" class="m-4 bg-gray-500 hover:bg-gray-600 px-6 py-2 rounded self-start">Kembali</button>
</div>

<!-- Kenangan Detail Page -->
<div id="kenanganDetailPage" class="hidden min-h-screen flex flex-col bg-black bg-opacity-70">
  <div class="flex justify-between items-center p-4">
    <h2 id="kenanganTitle" class="text-2xl font-bold"></h2>
    <div>
      <button onclick="addPhoto()" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded">+ Upload Foto</button>
      <button onclick="addPhotoLink()" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded ml-2">+ Upload Link</button>
      <button onclick="deleteGrup()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded ml-2">Hapus Grup</button>
    </div>
  </div>
  <div id="photoListWrapper" class="flex-1 flex justify-center items-center overflow-y-auto">
    <div id="photoList" class="grid grid-cols-2 gap-6"></div>
  </div>
  <div id="pagination" class="flex justify-center gap-2 p-4"></div>
  <button onclick="backFromDetailToKenangan()" class="m-4 bg-gray-500 hover:bg-gray-600 px-6 py-2 rounded self-start">Kembali</button>
</div>

<!-- Visi Page -->
<div id="visiPage" class="hidden min-h-screen flex flex-col items-center justify-center bg-black bg-opacity-70 text-center">
  <h2 class="text-3xl font-bold mb-6">âœ¨ Visi Kita âœ¨</h2>
  <p class="text-lg max-w-md">Aku ingin membangun hubungan yang tulus dan penuh percaya, di mana kita saling mendukung, menghargai, dan menghadirkan kehangatan satu sama lain. Hubungan ini bukan sekadar indah, tapi juga kuat dan berarti, membawa rasa nyaman dan bahagia bagi kita berdua.</p>
  <button onclick="backToMenu()" class="mt-6 bg-gray-500 hover:bg-gray-600 px-6 py-2 rounded">Kembali</button>
</div>

<!-- Harapan Page -->
<div id="harapanPage" class="hidden min-h-screen flex flex-col items-center justify-center bg-black bg-opacity-70 text-center">
  <h2 class="text-3xl font-bold mb-6">ðŸ’– Harapan ðŸ’–</h2>
  <div id="harapanList" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4"></div>
  <div id="harapanPagination" class="flex justify-center gap-2 mt-2"></div>
  <div class="flex gap-2 mb-4 w-full max-w-md">
    <input id="harapanInput" type="text" placeholder="Tambahkan harapan" class="flex-1 px-4 py-2 rounded-lg text-black focus:outline-none focus:ring-2 focus:ring-pink-500">
    <button onclick="addHarapan()" class="bg-pink-500 hover:bg-pink-600 px-4 py-2 rounded-lg text-white font-bold">Tambah</button>
  </div>
  <button onclick="backToMenu()" class="mt-6 bg-gray-500 hover:bg-gray-600 px-6 py-2 rounded">Kembali</button>
</div>

<!-- Lightbox -->
<div id="lightbox" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50" onclick="closeLightbox(event)">
  <div class="relative">
    <img id="lightboxImg" class="rounded-lg shadow-lg">
    <a id="downloadBtn" href="#" download class="absolute bottom-2 right-2 bg-blue-500 px-3 py-1 rounded text-white">Download</a>
    <button onclick="closeLightbox(event)" class="absolute top-2 right-2 bg-red-500 px-3 py-1 rounded text-white">X</button>
  </div>
</div>

<input type="file" id="fileInput" accept="image/*" class="hidden">

<script>
// ===== Firebase =====
const firebaseConfig = {
  apiKey: "AIzaSyAy1IMv6ugNGA578sx0n87IlxLGzCcCkes",
  authDomain: "project-ae3dc.firebaseapp.com",
  projectId: "project-ae3dc",
  storageBucket: "project-ae3dc.firebasestorage.app",
  messagingSenderId: "568389785825",
  appId: "1:568389785825:web:0260a79e523ea68299ffa0",
  measurementId: "G-VXYN6DC9YY"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ===== Cloudinary Config =====
const cloudName = "dtpskj8gv";
const apiKey = "312637785754871";
const apiSecret = "7XUOzrewsBO3Qnzcdh_8OcTe-ZM";
const uploadPreset = "Raynaldo";

// ===== Global =====
let currentKenangan = "";
let currentPage = 1;
const perPage = 4;
let currentPhotos = [];
let harapanPerPage = 10;
let currentHarapanPage = 1;
let allHarapan = [];

// ===== Login =====
function login() {
  const user = document.getElementById("username").value;
  const pass = document.getElementById("password").value;
  if(user==="raynaldo" && pass==="shafrina"){
    document.getElementById("loginPage").classList.add("hidden");
    document.getElementById("annivPage").classList.remove("hidden");
  } else { 
    document.getElementById("loginError").classList.remove("hidden"); 
  }
}

function checkAnniv(){
  const input = document.getElementById("annivInput").value;
  const target = "2025-08-23";
  if(input === target){
    localStorage.setItem('loginUser', 'raynaldo');
    localStorage.setItem('loginDate', new Date().toISOString().split('T')[0]);

    document.getElementById("annivPage").classList.add("hidden");
    document.getElementById("menuPage").classList.remove("hidden");
    renderHarapan();
    history.replaceState({page:'menuPage'}, '', '#menuPage');
  } else {
    document.getElementById("annivError").classList.remove("hidden");
  }
}

// ===== Navigasi =====
function openPage(page){
  document.querySelectorAll("body > div").forEach(d=>d.classList.add("hidden"));
  document.getElementById(page).classList.remove("hidden");
  if(page==="kenanganPage") renderSubmenu();
  if(page==="harapanPage") renderHarapan();

  if(history.state?.page === 'menuPage'){
    history.pushState({page:page}, '', '#'+page);
  }else{
    history.replaceState({page:page}, '', '#'+page);
  }
}

function backFromDetailToKenangan(){
  document.querySelectorAll("body > div").forEach(d=>d.classList.add("hidden"));
  document.getElementById('kenanganPage').classList.remove("hidden");
  history.replaceState({page:'kenanganPage'}, '', '#kenanganPage');
}

function backToMenu(){
  document.querySelectorAll("body > div").forEach(d=>d.classList.add("hidden"));
  document.getElementById('menuPage').classList.remove("hidden");
  history.replaceState({page:'menuPage'}, '', '#menuPage');
}

window.addEventListener('popstate', e=>{
  const page = e.state?.page || 'menuPage';
  document.querySelectorAll("body > div").forEach(d=>d.classList.add("hidden"));
  document.getElementById(page).classList.remove("hidden");
});

// ===== Kenangan Submenu =====
async function renderSubmenu(){
  const container=document.getElementById("submenuList");
  container.innerHTML="";
  const snapshot=await db.collection("kenangan").get();
  snapshot.forEach(doc=>{
    const name=doc.id;
    const btn=document.createElement("button");
    btn.className="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg shadow-lg";
    btn.textContent=name;
    btn.onclick=()=>openKenanganDetail(name);
    container.appendChild(btn);
  });
}

async function openKenanganDetail(name){
  currentKenangan = name;
  currentPage = 1;
  currentPhotos = [];
  document.getElementById("photoList").replaceChildren();
  document.getElementById("pagination").replaceChildren();
  document.querySelectorAll("body > div").forEach(d => d.classList.add("hidden"));
  document.getElementById("kenanganDetailPage").classList.remove("hidden");
  document.getElementById("kenanganTitle").textContent = name;

  const doc = await db.collection("kenangan").doc(currentKenangan).get();
  currentPhotos = doc.exists ? (doc.data().photos || []) : [];
  renderPhotos();
  history.pushState({page:'kenanganDetailPage'}, '', '#kenanganDetailPage');
}

// ===== Render Photos =====
function renderPhotos(){
  const list=document.getElementById("photoList"); 
  const pagination=document.getElementById("pagination");
  list.innerHTML=""; 
  pagination.innerHTML="";
  const totalPages=Math.ceil(currentPhotos.length/perPage);
  const start=(currentPage-1)*perPage; 
  const end=start+perPage; 
  const pagePhotos=currentPhotos.slice(start,end);

  pagePhotos.forEach((photo,index)=>{
  const div=document.createElement("div"); 
  div.className="relative";

  const img=document.createElement("img"); 
  // Jika photo adalah objek Cloudinary, buat thumbnail URL
  let thumbUrl = photo.url || photo; // default link asli
  if(photo.public_id){
    thumbUrl = `https://res.cloudinary.com/${cloudName}/image/upload/w_150,h_150,c_fill,q_auto/${photo.public_id}.jpg`;
  }

  img.src = thumbUrl; 
  img.dataset.full = photo.url || photo; // tetap URL asli
  img.loading="lazy"; 
  img.className="thumbnail-img cursor-pointer";
  img.onclick=()=>openLightbox(img.dataset.full);

  const delBtn=document.createElement("button");
  delBtn.textContent="X";
  delBtn.className="absolute top-1 right-1 bg-red-500 px-2 py-1 text-white rounded";
  delBtn.onclick = async (e) => {
    e.stopPropagation();
    if(!confirm("Hapus foto ini?")) return;
    const globalIndex = (currentPage-1)*perPage + index;
    const photoItem = currentPhotos[globalIndex];

    // Hapus Cloudinary jika ada public_id
    if(photoItem.public_id){
      try{
        const timestamp = Math.floor(Date.now()/1000);
        const payload = `public_id=${photoItem.public_id}&timestamp=${timestamp}${apiSecret}`;
        const sha1 = await crypto.subtle.digest('SHA-1', new TextEncoder().encode(payload));
        const signature = Array.from(new Uint8Array(sha1)).map(b=>b.toString(16).padStart(2,'0')).join('');
        const formData = new FormData();
        formData.append("public_id", photoItem.public_id);
        formData.append("api_key", apiKey);
        formData.append("timestamp", timestamp);
        formData.append("signature", signature);
        const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/destroy`, {method:"POST", body:formData});
        const data = await res.json();
        if(data.result !== "ok") throw new Error("Gagal hapus Cloudinary");
      } catch(err){console.error(err); alert("Gagal hapus foto dari Cloudinary"); return;}
    }

    currentPhotos.splice(globalIndex,1);
    await db.collection("kenangan").doc(currentKenangan).update({photos: currentPhotos});
    if(currentPhotos.length===0){backFromDetailToKenangan(); return;}
    if(currentPage>Math.ceil(currentPhotos.length/perPage)) currentPage=Math.ceil(currentPhotos.length/perPage);
    renderPhotos();
  };

  div.appendChild(img);
  div.appendChild(delBtn);
  list.appendChild(div);
});

  for(let i=1;i<=totalPages;i++){
    const btn=document.createElement("button");
    btn.textContent=i;
    btn.className=`px-3 py-1 rounded ${i===currentPage?'bg-blue-500':'bg-gray-600 hover:bg-gray-700'}`;
    btn.onclick=()=>{currentPage=i; renderPhotos();};
    pagination.appendChild(btn);
  }
}

// ===== Lightbox =====
function openLightbox(url){
  const lb=document.getElementById("lightbox");
  const img=document.getElementById("lightboxImg");
  const dl=document.getElementById("downloadBtn");
  img.src=url; dl.href=url;
  lb.classList.remove("hidden");
}
function closeLightbox(e){
  if(!e || e.target.id==='lightbox' || e.target.tagName==='BUTTON') document.getElementById("lightbox").classList.add("hidden");
}

// ===== Tambah / Hapus Grup & Foto =====
async function addSubmenu(){
  const name=prompt("Nama grup kenangan:"); 
  if(!name) return;
  const doc=await db.collection("kenangan").doc(name).get();
  if(doc.exists){ alert("Nama grup sudah ada!"); return;}
  await db.collection("kenangan").doc(name).set({photos:[]});
  renderSubmenu();
}

function addPhoto(){
  document.getElementById("fileInput").click();
}

document.getElementById("fileInput").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if(!file) return;
  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", uploadPreset);
  try{
    const res=await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {method:"POST", body:formData});
    const data=await res.json();
    if(data.secure_url){
      const doc = await db.collection("kenangan").doc(currentKenangan).get();
      const photos = doc.exists ? (doc.data().photos || []) : [];
      photos.push({url: data.secure_url, public_id: data.public_id});
      await db.collection("kenangan").doc(currentKenangan).update({photos});
      currentPhotos = photos;
      renderPhotos();
    } else alert("Upload gagal!");
  }catch(err){console.error(err); alert("Upload gagal!");}
});

// Upload Link
async function addPhotoLink(){
  const link = prompt("Masukkan URL foto:");
  if(!link) return;
  const doc = await db.collection("kenangan").doc(currentKenangan).get();
  const photos = doc.exists ? (doc.data().photos || []) : [];
  photos.push(link);
  await db.collection("kenangan").doc(currentKenangan).update({photos});
  currentPhotos = photos;
  renderPhotos();
}

// Hapus Grup
async function deleteGrup(){
  if(!confirm("Hapus grup ini?")) return;
  await db.collection("kenangan").doc(currentKenangan).delete();
  backToMenu();
}

// ===== Harapan =====
async function renderHarapan(page=1){
  const list=document.getElementById("harapanList");
  list.innerHTML="";
  const pagination=document.getElementById("harapanPagination");

  const snapshot = await db.collection("harapan").get();
  allHarapan = snapshot.docs.map(doc=>({id:doc.id, text:doc.data().text}));
  const totalPages = Math.ceil(allHarapan.length/harapanPerPage);
  if(totalPages>0 && page>totalPages) page=totalPages;
  currentHarapanPage=page;

  const start=(page-1)*harapanPerPage;
  const end=start+harapanPerPage;
  const pageHarapan = allHarapan.slice(start,end);

  pageHarapan.forEach(h=>{
    const div=document.createElement("div");
    div.className="flex justify-between items-center bg-pink-600 bg-opacity-70 hover:bg-pink-700 transition p-3 rounded-lg shadow-md";

    const textSpan=document.createElement("span");
    textSpan.textContent=h.text; textSpan.className="text-white font-medium";

    const del=document.createElement("button");
    del.textContent="X"; del.className="bg-red-500 hover:bg-red-600 px-2 py-1 rounded ml-2 text-white";
    del.onclick=async ()=>{
      if(!confirm("Yakin ingin menghapus harapan ini?")) return;
      await db.collection("harapan").doc(h.id).delete();
      renderHarapan(currentHarapanPage);
    };

    div.appendChild(textSpan); div.appendChild(del); list.appendChild(div);
  });

  pagination.innerHTML="";
  for(let i=1;i<=totalPages;i++){
    const btn=document.createElement("button");
    btn.textContent=i; btn.className=`px-3 py-1 rounded ${i===currentHarapanPage?'bg-blue-500':'bg-gray-600 hover:bg-gray-700'}`;
    btn.onclick=()=>{ currentHarapanPage=i; renderHarapan(i); };
    pagination.appendChild(btn);
  }
}

async function addHarapan(){
  const input=document.getElementById("harapanInput");
  const text=input.value.trim();
  if(!text) return;
  await db.collection("harapan").add({text});
  input.value="";
  renderHarapan();
}

// ===== Visi =====
// Visi bersifat statis, sudah ada di HTML, tidak perlu JS tambahan kecuali ingin diambil dari Firestore
async function renderVisi(){
  const doc = await db.collection("visi").doc("main").get();
  if(doc.exists){
    document.querySelector("#visiPage p").textContent = doc.data().text;
  }
}

// Panggil sekali saat load untuk menampilkan visi jika disimpan di Firestore
renderVisi();
</script>
</body>
</html>
